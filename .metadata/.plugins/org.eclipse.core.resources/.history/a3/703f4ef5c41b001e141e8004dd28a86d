package com.sagachoreographyos.service;


import java.util.function.Consumer;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.kafka.annotation.KafkaListener;
import org.springframework.stereotype.Service;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.JsonMappingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.project.common.dto.OrderRequestDto;
import com.project.common.event.OrderEvent;
import com.project.common.event.Orderstatus;
import com.project.common.event.PaymentEvent;
import com.project.common.event.PaymentStatus;
import com.project.order.entity.PurchaseOrder;
import com.project.order.repository.OrderRepository;

import jakarta.transaction.Transactional;

@Service
public class OrderConsumer {
	@Autowired
	private ObjectMapper objectMapper;
	@Autowired
	private OrderRepository orderRepository;
	@Autowired
	private OrderPublisher orderPublisher;
	
	
	
	@KafkaListener(topics = "Topic2",groupId = "Group2")
	public void paymentEventListner(String message) throws JsonMappingException, JsonProcessingException {
		PaymentEvent pe = objectMapper.readValue(message,PaymentEvent.class);
		System.out.println(pe.getPaymentStatus());
		handlePaymentEvent(pe.getPaymentRequestDto().getOrderId(),p->{p.setPaymentStatus(pe.getPaymentStatus());});
	}

	@Transactional
	private void handlePaymentEvent(int id,Consumer<PurchaseOrder> consumer) {
		
	 orderRepository.findById(id).ifPresent(consumer.andThen(this::updateOrder));
		
	}
	
	public void updateOrder(PurchaseOrder purchaseOrder) {
		
		boolean isPaymentComplete = PaymentStatus.PAYMENT_COMPLETED.equals(purchaseOrder.getPaymentStatus());
		
		Orderstatus orderStatus = isPaymentComplete ? Orderstatus.ORDER_COMPLETED : Orderstatus.ORDER_CANCELLED;
		purchaseOrder.setOrderStatus(orderStatus);
		orderRepository.save(purchaseOrder);
		//orderPublisher.sendMsgtoTopic(convertToDto(purchaseOrder));
		if(!isPaymentComplete) {
			orderPublisher.sendMsgtoTopic(convertToDto(purchaseOrder));
		}
	}

	private OrderEvent convertToDto(PurchaseOrder purchaseOrder) {
		OrderRequestDto orderRequestDto = new OrderRequestDto();
		orderRequestDto.setOrderId(purchaseOrder.getId());
		orderRequestDto.setUserId(purchaseOrder.getUserId());
		orderRequestDto.setAmount(purchaseOrder.getPrice());
		orderRequestDto.setProductId(purchaseOrder.getProductId());
		return new OrderEvent(orderRequestDto,purchaseOrder.getOrderStatus());
	}
	

	
}
